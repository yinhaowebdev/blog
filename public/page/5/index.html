<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Billy&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Billy&#39;s blog">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Billy&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Billy Yin">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Billy's blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Billy&#39;s blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Actually it is more like a hand note of myself</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-初步理解React-Fiber" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/19/%E5%88%9D%E6%AD%A5%E7%90%86%E8%A7%A3React-Fiber/" class="article-date">
  <time class="dt-published" datetime="2020-01-19T07:12:00.000Z" itemprop="datePublished">2020-01-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/19/%E5%88%9D%E6%AD%A5%E7%90%86%E8%A7%A3React-Fiber/">初步理解React Fiber</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Fiber是React 16中新的协调器（Reconciler）</p>
<h3 id="之前的协调器"><a href="#之前的协调器" class="headerlink" title="之前的协调器"></a>之前的协调器</h3><p>Stack Reconciler<br>见<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0c50f06de379">React Diff 初探</a></p>
<p>一口气执行所有的Diff，render和真实DOM改变</p>
<p>缺点：js执行是单线程的，它将GUI描绘，时间器处理，事件处理，JS执行，远程资源加载统统放在一起，阻塞其他任务，影响用户体验</p>
<h3 id="Fiber的目标"><a href="#Fiber的目标" class="headerlink" title="Fiber的目标"></a>Fiber的目标</h3><p>一种能够彻底解决主线程长时间占用问题的机制</p>
<blockquote>
<p>The “fiber” reconciler is a new effort aiming to resolve the problems inherent in the stack reconciler and fix a few long-standing issues.</p>
</blockquote>
<h3 id="Fiber的基本思想"><a href="#Fiber的基本思想" class="headerlink" title="Fiber的基本思想"></a>Fiber的基本思想</h3><p>把渲染和更新拆分成小任务，拆分的粒度称为Fiber。通过合理的调度机制来达到更强的控制力</p>
<p><img src="https://upload-images.jianshu.io/upload_images/9594241-5b7524cfd8f3d184.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Stack Reconciler "></p>
<p><img src="https://upload-images.jianshu.io/upload_images/9594241-7781a8cbb8dc0313.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Fiber Reconciler"></p>
<h4 id="两个阶段"><a href="#两个阶段" class="headerlink" title="两个阶段"></a>两个阶段</h4><h6 id="1-diff阶段-（reconciliation-render）"><a href="#1-diff阶段-（reconciliation-render）" class="headerlink" title="1 diff阶段 （reconciliation &#x2F; render）"></a>1 diff阶段 （reconciliation &#x2F; render）</h6><p>找出新老实例的差异和对应的DOM change</p>
<p>可以拆分，默认为低优先级任务，可以暂停或重来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[UNSAFE_]componentWillMount</span><br><span class="line">[UNSAFE_]componentWillReceiveProps</span><br><span class="line">getDerivedStateFromProps</span><br><span class="line">shouldComponentUpdate</span><br><span class="line">[UNSAFE_]componentWillUpdate</span><br><span class="line">render</span><br></pre></td></tr></table></figure>
<h6 id="2-patch阶段-（commit）"><a href="#2-patch阶段-（commit）" class="headerlink" title="2 patch阶段 （commit）"></a>2 patch阶段 （commit）</h6><p>把找出的DOM change应用到DOM上，是一连串的DOM操作</p>
<p>不可拆分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getSnapshotBeforeUpdate</span><br><span class="line">componentDidMount</span><br><span class="line">componentDidUpdate</span><br><span class="line">componentWillUnmount</span><br></pre></td></tr></table></figure>
<h4 id="粒度"><a href="#粒度" class="headerlink" title="粒度"></a>粒度</h4><p>基本单位称为fiber，fiber tree 是通过 virtual dom tree 对应的构造出来的，可以理解为一个fiber对应一个虚拟dom节点</p>
<h4 id="fiber-tree-结构"><a href="#fiber-tree-结构" class="headerlink" title="fiber tree 结构"></a>fiber tree 结构</h4><p>每个节点存储return, child, sibling，分别对应父节点， 第一个孩子， 它右边的兄弟。有了它们，我们可以把树结构变成链表结构，以此实现深度优先遍历。<br><img src="https://upload-images.jianshu.io/upload_images/9594241-923f284109f901a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="fiber tree"></p>
<h4 id="workloop"><a href="#workloop" class="headerlink" title="workloop"></a>workloop</h4><p>基本规则是：每个工作单元结束检查是否还有时间做下一个，没时间了就先“挂起”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// Flush asynchronous work until there&#x27;s a higher priority event</span><br><span class="line">while (nextUnitOfWork !== null &amp;&amp; !shouldYieldToRenderer()) &#123;</span><br><span class="line">      nextUnitOfWork = performUnitOfWork(nextUnitOfWork);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>优先级规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module.exports = &#123;</span><br><span class="line">  NoWork: 0, // No work is pending.</span><br><span class="line">  SynchronousPriority: 1, // For controlled text inputs. Synchronous side-effects.</span><br><span class="line">  AnimationPriority: 2, // Needs to complete before the next frame.</span><br><span class="line">  HighPriority: 3, // Interaction that needs to complete pretty soon to feel responsive.</span><br><span class="line">  LowPriority: 4, // Data fetching, or result from updating stores.</span><br><span class="line">  OffscreenPriority: 5, // Won&#x27;t be visible but do the work in case it becomes visible.</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>优先级策略的核心是，在reconciliation阶段，低优先级的操作可以被高优先级的操作打断，并让主线程执行高优先级的更新，用户可感知的响应更快。</p>
<h4 id="断点-恢复"><a href="#断点-恢复" class="headerlink" title="断点&#x2F;恢复"></a>断点&#x2F;恢复</h4><p>在需要退出主线程占用时保存当前的成果（effectlist），tag标记当前节点，开一个requestIdleCallback，等下一次被唤起继续进行或重新开始</p>
<h4 id="requestIdleCallback"><a href="#requestIdleCallback" class="headerlink" title="requestIdleCallback"></a>requestIdleCallback</h4><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestIdleCallback">MDN文档</a></p>
<blockquote>
<p>window.requestIdleCallback()方法将在浏览器的空闲时段内调用的函数排队。这使开发者能够在主事件循环上执行后台和低优先级工作，而不会影响延迟关键事件，如动画和输入响应。函数一般会按先进先调用的顺序执行，然而，如果回调函数指定了执行超时时间timeout，则有可能为了在超时前执行函数而打乱执行顺序。</p>
</blockquote>
<p>对于不支持这个API的浏览器，react会加上pollyfill。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>react fiber解决了前的栈协调器之带来的任务阻塞问题</li>
<li>从执行上来看，render及之前的生命周期属于diff阶段，可以异步执行，render后的生命周期属于patch阶段，同步执行</li>
<li>diff阶段的过程实际上就是收集effectList的过程</li>
<li>尽量不要在diff阶段的生命周期中编写含有副作用的代码</li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://juejin.im/post/5c70f044f265da2de4507ab9">https://juejin.im/post/5c70f044f265da2de4507ab9</a><br><a target="_blank" rel="noopener" href="https://github.com/MuYunyun/blog/blob/master/React/%E6%B7%B1%E5%85%A5Fiber%E6%9E%B6%E6%9E%84.md">https://github.com/MuYunyun/blog/blob/master/React/%E6%B7%B1%E5%85%A5Fiber%E6%9E%B6%E6%9E%84.md</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/51483167">https://zhuanlan.zhihu.com/p/51483167</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/57346388">https://zhuanlan.zhihu.com/p/57346388</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/58863799">https://zhuanlan.zhihu.com/p/58863799</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/01/19/%E5%88%9D%E6%AD%A5%E7%90%86%E8%A7%A3React-Fiber/" data-id="cm48jokd2001coni802fn785n" data-title="初步理解React Fiber" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-React-虚拟DOM的-typeof-属性" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/15/React-%E8%99%9A%E6%8B%9FDOM%E7%9A%84-typeof-%E5%B1%9E%E6%80%A7/" class="article-date">
  <time class="dt-published" datetime="2019-11-15T03:22:00.000Z" itemprop="datePublished">2019-11-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/15/React-%E8%99%9A%E6%8B%9FDOM%E7%9A%84-typeof-%E5%B1%9E%E6%80%A7/">React 虚拟DOM的 $$typeof 属性</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>研究React虚拟DOM时尝试打印JSX元素，有个属性不太熟悉<br><img src="https://upload-images.jianshu.io/upload_images/9594241-5036feed28f45e22.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="capture.png"></p>
<p>其它的都可以理解，但是这个 $$typeof 是啥？？？</p>
<p>在研究了网上的资料后，得出结论，这是用于防止XSS攻击的一种方式。</p>
<h3 id="JSX中插入HTML结构"><a href="#JSX中插入HTML结构" class="headerlink" title="JSX中插入HTML结构"></a>JSX中插入HTML结构</h3><p>在传统前端开发中经常使用HTML字符串拼接然后append的方式向页面中引入HTML结构</p>
<p>但这样的写法在React中好像不可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const html = &#x27;&lt;div&gt;123&lt;/div&gt;&#x27;</span><br><span class="line"></span><br><span class="line">function App(props) &#123;</span><br><span class="line">    return (</span><br><span class="line">        &lt;div className=&quot;App&quot;&gt;</span><br><span class="line">            &#123;html&#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/9594241-415b5ee4d6c4489e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<p>原因：React等现代前端lib为了防止XSS攻击，对 &lt; &gt; 等符号做了一层转义，称为 <code>escape </code></p>
<p>如果真的想插入HTML结构而非文本呢？ </p>
<h3 id="dangerouslySetInnerHTML"><a href="#dangerouslySetInnerHTML" class="headerlink" title="dangerouslySetInnerHTML"></a>dangerouslySetInnerHTML</h3><blockquote>
<p>dangerouslySetInnerHTML 是 React 为浏览器 DOM 提供 innerHTML 的替换方案。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const html = &#x27;&lt;div&gt;123&lt;/div&gt;&#x27;</span><br><span class="line"></span><br><span class="line">function App(props) &#123;</span><br><span class="line">    return (</span><br><span class="line">        &lt;div</span><br><span class="line">            className=&quot;App&quot;</span><br><span class="line">            dangerouslySetInnerHTML=&#123;&#123; __html: html &#125;&#125;</span><br><span class="line">        &gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/9594241-8411dad579087a4f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"></p>
<h3 id="风险？"><a href="#风险？" class="headerlink" title="风险？"></a>风险？</h3><p>场景：你的服务器存在一个漏洞，使得用户可以存储任意的JSON对象，但客户端却需要一个 string 类型的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// 期望该字段为text但是拿到了JSON</span><br><span class="line">let expectedTextButGotJSON = &#123;</span><br><span class="line">  type: &#x27;div&#x27;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    dangerouslySetInnerHTML: &#123;</span><br><span class="line">      __html: &#x27;&lt;img src onerror=&quot;alert(document.cookie)&quot;/&gt;&#x27;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  // ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// JSX</span><br><span class="line">&lt;p&gt;</span><br><span class="line">  &#123;expectedTextButGotJSON&#125;</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>按照Virtual DOM 的渲染机制（<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/536d43ce8479">学习React VirtualDom</a>），有风险的节点会直接被渲染到DOM树。</p>
<h3 id="typeof"><a href="#typeof" class="headerlink" title="$$typeof"></a>$$typeof</h3><p>React  0.14版本之后，在渲染节点时，新增了一步校验</p>
<p>首先新增一个常量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var REACT_ELEMENT_TYPE =</span><br><span class="line">  (typeof Symbol === &#x27;function&#x27; &amp;&amp; Symbol.for &amp;&amp; Symbol.for(&#x27;react.element&#x27;)) ||</span><br><span class="line">  0xeac7;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>如果浏览器支持 Symbol：</p>
<p>生成虚拟DOM对象时，自带属性$$typeof :  Symbol.for(‘react.element’)</p>
<p>React渲染时，会做校验：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ReactElement.isValidElement = function (object) &#123;</span><br><span class="line">  return typeof object === &#x27;object&#x27; &amp;&amp; object !== null &amp;&amp; object.$$typeof === REACT_ELEMENT_TYPE;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>为什么用 Symbol.for 呢？</p>
<p>1 Symbol属性不可存放于JSON中</p>
<p>2 Symbol(‘react.element’) !&#x3D;&#x3D; Symbol(‘react.element’) 但 Symbol.for(‘react.element’) &#x3D;&#x3D;&#x3D; Symbol.for(‘react.element’)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/15/React-%E8%99%9A%E6%8B%9FDOM%E7%9A%84-typeof-%E5%B1%9E%E6%80%A7/" data-id="cm48jokcz000poni881s35o07" data-title="React 虚拟DOM的 $$typeof 属性" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ES6-Proxy" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/07/ES6-Proxy/" class="article-date">
  <time class="dt-published" datetime="2019-11-06T16:10:00.000Z" itemprop="datePublished">2019-11-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/07/ES6-Proxy/">ES6 Proxy</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>Proxy 可以理解成，在目标对象之前架设一层“拦截”，外界对该对象的访问，都必须先通过这层拦截，因此提供了一种机制，可以对外界的访问进行过滤和改写。</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>let p &#x3D; new Proxy(target, handler);</p>
<h6 id="set"><a href="#set" class="headerlink" title="set"></a>set</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const obj = &#123; name: &#x27;&#x27; &#125;</span><br><span class="line"></span><br><span class="line">const proxy = new Proxy(obj, &#123;</span><br><span class="line">    set: (target, prop, value) =&gt; &#123;</span><br><span class="line">        target[prop] = value.toString().toUpperCase();</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">proxy.name = &#x27;a&#x27;;</span><br><span class="line"></span><br><span class="line">console.log(obj)</span><br><span class="line">console.log(proxy)</span><br></pre></td></tr></table></figure>
<h6 id="get"><a href="#get" class="headerlink" title="get"></a>get</h6><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const obj = &#123;</span><br><span class="line">    name: &#x27;a&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const proxy = new Proxy(obj, &#123;</span><br><span class="line">    get: (target, prop) =&gt; &#123;</span><br><span class="line">        return target[prop].toString().toUpperCase()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">console.log(proxy.name)</span><br></pre></td></tr></table></figure>
<h5 id="has"><a href="#has" class="headerlink" title="has"></a>has</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const obj = &#123; name: &#x27;&#x27; &#125;</span><br><span class="line"></span><br><span class="line">const proxy = new Proxy(obj, &#123;</span><br><span class="line">    has: (target, prop) =&gt; &#123;</span><br><span class="line">        console.log(`call $&#123;prop&#125; values $&#123;target[prop]&#125;`)</span><br><span class="line">        return target[prop] !== undefined;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">console.log(&#x27;name&#x27; in proxy)</span><br></pre></td></tr></table></figure>
<h5 id="deleteProperty"><a href="#deleteProperty" class="headerlink" title="deleteProperty"></a>deleteProperty</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">const obj = &#123;</span><br><span class="line">    a: 1,</span><br><span class="line">    b: 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const proxy = new Proxy(obj, &#123;</span><br><span class="line">    deleteProperty: (target, prop) =&gt; &#123;</span><br><span class="line">        if (prop === &#x27;b&#x27;) &#123;</span><br><span class="line">            return false</span><br><span class="line">        &#125;</span><br><span class="line">        delete target[prop]</span><br><span class="line">        return true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">delete proxy.b</span><br><span class="line"></span><br><span class="line">console.log(obj)</span><br><span class="line"></span><br><span class="line">delete proxy.a</span><br><span class="line"></span><br><span class="line">console.log(obj)</span><br></pre></td></tr></table></figure>

<h5 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function sum(a, b) &#123;</span><br><span class="line">    return a + b;</span><br><span class="line">&#125;</span><br><span class="line">const absSum = new Proxy(sum, &#123;</span><br><span class="line">    apply(target, thisArg, args) &#123;</span><br><span class="line">        const value = target.apply(thisArg, args);</span><br><span class="line">        return value &lt; 0 ? -value : value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">console.log(absSum(-1, -2));</span><br></pre></td></tr></table></figure>
<h5 id="更多API见https-developer-mozilla-org-zh-CN-docs-Web-JavaScript-Reference-Global-Objects-Proxy"><a href="#更多API见https-developer-mozilla-org-zh-CN-docs-Web-JavaScript-Reference-Global-Objects-Proxy" class="headerlink" title="更多API见https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects&#x2F;Proxy#"></a>更多API见<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy#">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects&#x2F;Proxy#</a></h5><h3 id="Proxy-相比于-Object-defineProperty-优势"><a href="#Proxy-相比于-Object-defineProperty-优势" class="headerlink" title="Proxy 相比于 Object.defineProperty 优势"></a>Proxy 相比于 Object.defineProperty 优势</h3><h5 id="监听数组事件"><a href="#监听数组事件" class="headerlink" title="监听数组事件"></a>监听数组事件</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">const obj = &#123;&#125;</span><br><span class="line">var list = [1, 2, 3]</span><br><span class="line">Object.defineProperty(obj, &#x27;list&#x27;, &#123;</span><br><span class="line">    get: () =&gt; &#123;</span><br><span class="line">        return list</span><br><span class="line">    &#125;,</span><br><span class="line">    set: (newVal) =&gt; &#123;</span><br><span class="line">        console.log(newVal)</span><br><span class="line">        list = newVal</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">obj.list.push(4)</span><br><span class="line">obj.list = [1, 2, 3, 4, 5]</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">const list = [1, 2, 3]</span><br><span class="line"></span><br><span class="line">var proxyObj = new Proxy(list, &#123;</span><br><span class="line">    set: (target, property, value) =&gt; &#123;</span><br><span class="line">        console.log(&#x27;set&#x27;)</span><br><span class="line">        console.log(property, value)</span><br><span class="line">        return Reflect.set(target, property, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">proxyObj.push(4)</span><br></pre></td></tr></table></figure>
<p>Reflect对象与Proxy对象一样，也是ES6为了操作对象而提供的新API。<br> 详见: <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Reflect">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects&#x2F;Reflect</a></p>
<h5 id="监听的是一整个对象而非对象的某个属性"><a href="#监听的是一整个对象而非对象的某个属性" class="headerlink" title="监听的是一整个对象而非对象的某个属性"></a>监听的是一整个对象而非对象的某个属性</h5><blockquote>
<p>let p &#x3D; new Proxy(target, handler);</p>
</blockquote>
<p>vs</p>
<blockquote>
<p>Object.defineProperty(obj, prop, descriptor)</p>
</blockquote>
<h5 id="支持嵌套代理"><a href="#支持嵌套代理" class="headerlink" title="支持嵌套代理"></a>支持嵌套代理</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">let obj = &#123;</span><br><span class="line">    info: &#123;</span><br><span class="line">        name: &#x27;eason&#x27;,</span><br><span class="line">        blogs: [&#x27;webpack&#x27;, &#x27;babel&#x27;, &#x27;cache&#x27;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">let handler = &#123;</span><br><span class="line">    get(target, key) &#123;</span><br><span class="line">        console.log(&#x27;get&#x27;, key)</span><br><span class="line">        // 递归创建并返回</span><br><span class="line">        if (typeof target[key] === &#x27;object&#x27; &amp;&amp; target[key] !== null) &#123;</span><br><span class="line">            return new Proxy(target[key], handler)</span><br><span class="line">        &#125;</span><br><span class="line">        return Reflect.get(target, key)</span><br><span class="line">    &#125;,</span><br><span class="line">    set(target, key, value) &#123;</span><br><span class="line">        console.log(&#x27;set&#x27;, key, value)</span><br><span class="line">        return Reflect.set(target, key, value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">let proxy = new Proxy(obj, handler)</span><br><span class="line">// 以下两句都能够进入 set</span><br><span class="line">proxy.info.name = &#x27;Zoe&#x27;</span><br><span class="line">proxy.info.blogs.push(&#x27;proxy&#x27;)</span><br></pre></td></tr></table></figure>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><h5 id="实现观察者模式"><a href="#实现观察者模式" class="headerlink" title="实现观察者模式"></a>实现观察者模式</h5><blockquote>
<p>Vue 3.0 使用 Proxy 代替 Object.defineProperty 实现双向绑定</p>
</blockquote>
<h5 id="数据校验"><a href="#数据校验" class="headerlink" title="数据校验"></a>数据校验</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">const obj = &#123;</span><br><span class="line">    phone: &#x27;13888888888&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const proxy = new Proxy(obj, &#123;</span><br><span class="line">    set: (target, prop, value) =&gt; &#123;</span><br><span class="line">        if (prop === &#x27;phone&#x27; &amp;&amp; !/^(\+86)?1[\d]&#123;10&#125;$/.test(value)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        target[prop] = value;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">proxy.phone = &#x27;a&#x27;</span><br><span class="line"></span><br><span class="line">console.log(proxy)</span><br><span class="line"></span><br><span class="line">proxy.phone = &#x27;13899999999&#x27;</span><br><span class="line"></span><br><span class="line">console.log(proxy)</span><br></pre></td></tr></table></figure>

<h5 id="添加实用方法"><a href="#添加实用方法" class="headerlink" title="添加实用方法"></a>添加实用方法</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">const list = [</span><br><span class="line">    &#123; name: &#x27;a&#x27;, phone: &#x27;13888888888&#x27; &#125;,</span><br><span class="line">    &#123; name: &#x27;b&#x27;, phone: &#x27;13899999999&#x27; &#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">const proxyList = new Proxy(list, &#123;</span><br><span class="line">    get: (target, prop) =&gt; &#123;</span><br><span class="line">        if (prop in target) &#123;</span><br><span class="line">            return target[prop];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (const item of target) &#123;</span><br><span class="line">            if (item.name === prop) &#123;</span><br><span class="line">                return item;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return undefined;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">console.log(proxyList[0]);</span><br><span class="line">console.log(proxyList[&quot;a&quot;]);</span><br></pre></td></tr></table></figure>
<h3 id="Proxy的坑"><a href="#Proxy的坑" class="headerlink" title="Proxy的坑"></a>Proxy的坑</h3><h5 id="this指向问题"><a href="#this指向问题" class="headerlink" title="this指向问题"></a>this指向问题</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">const target = &#123;</span><br><span class="line">    m: function () &#123;</span><br><span class="line">        console.log(this === target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">const proxy = new Proxy(target, &#123;&#125;);</span><br><span class="line">target.m() // true</span><br><span class="line">proxy.m() // false</span><br></pre></td></tr></table></figure>
<p>解决</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const target = &#123;</span><br><span class="line">    m: function () &#123;</span><br><span class="line">        console.log(this === target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">const proxy = new Proxy(target, &#123;</span><br><span class="line">    get(target, prop) &#123;</span><br><span class="line">        return target[prop].bind(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">target.m() // true</span><br><span class="line">proxy.m() // true</span><br></pre></td></tr></table></figure>





      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/11/07/ES6-Proxy/" data-id="cm48jokcx0009oni8fg2670e5" data-title="ES6 Proxy" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-实现简单的vscode插件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/12/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84vscode%E6%8F%92%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2019-10-11T16:15:00.000Z" itemprop="datePublished">2019-10-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/12/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84vscode%E6%8F%92%E4%BB%B6/">实现简单的vscode插件</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><p>脚手架工具 Yeoman 和 Generator-code</p>
<blockquote>
<p>cnpm install -g yo generator-code</p>
</blockquote>
<p>插件打包和发布工具 vsce</p>
<blockquote>
<p>cnpm install -g vsce</p>
</blockquote>
<h3 id="使用脚手架搭建vscode项目"><a href="#使用脚手架搭建vscode项目" class="headerlink" title="使用脚手架搭建vscode项目"></a>使用脚手架搭建vscode项目</h3><blockquote>
<p>yo code</p>
</blockquote>
<p>选择 “New Extension (JavaScript)”</p>
<h3 id="编辑项目"><a href="#编辑项目" class="headerlink" title="编辑项目"></a>编辑项目</h3><p>编辑 package.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// ...</span><br><span class="line">&quot;contributes&quot;: &#123;</span><br><span class="line">        &quot;commands&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;command&quot;: &quot;extension.helloWorld&quot;,</span><br><span class="line">                &quot;title&quot;: &quot;Hello World&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;snippets&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;language&quot;: &quot;javascript&quot;,</span><br><span class="line">                &quot;path&quot;: &quot;./snippets/javascript.json&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>mkdir snippets<br>cd snippets<br>touch javascript.json<br>vim javascript.json</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;forEach&quot;: &#123;</span><br><span class="line">        &quot;prefix&quot;: &quot;fe&quot;,</span><br><span class="line">        &quot;body&quot;: [</span><br><span class="line">            &quot;$&#123;1:array&#125;.forEach(function(item) &#123;&quot;,</span><br><span class="line">            &quot;\t$&#123;2:// body&#125;&quot;,</span><br><span class="line">            &quot;&#125;);&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;description&quot;: &quot;Code snippet for \&quot;forEach\&quot;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;setTimeout1000&quot;: &#123;</span><br><span class="line">        &quot;prefix&quot;: &quot;st1000&quot;,</span><br><span class="line">        &quot;body&quot;: [</span><br><span class="line">            &quot;setTimeout(function() &#123;&quot;,</span><br><span class="line">            &quot;\t$&#123;0:// body&#125;&quot;,</span><br><span class="line">            &quot;&#125;, $&#123;1:1000&#125;);&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;description&quot;: &quot;Code snippet for &#x27;setTimeout&#x27;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;HelloWorld&quot;: &#123;</span><br><span class="line">        &quot;prefix&quot;: &quot;hello&quot;,</span><br><span class="line">        &quot;body&quot;: [</span><br><span class="line">            &quot;console.log(&#x27;hello world&#x27;)&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;description&quot;: &quot;Code snippet for &#x27;hello world&#x27;&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;dispatch&quot;: &#123;</span><br><span class="line">        &quot;prefix&quot;: &quot;dispatch&quot;,</span><br><span class="line">        &quot;body&quot;: [</span><br><span class="line">            &quot;dispatch(&#123;&quot;,</span><br><span class="line">            &quot;\ttype:&#x27;$&#123;0://type&#125;&#x27;,&quot;,</span><br><span class="line">            &quot;\tpayload:&#123;&quot;,</span><br><span class="line">            &quot;\t\t$&#123;2:// payload&#125;&quot;,</span><br><span class="line">            &quot;\t&#125;&quot;,</span><br><span class="line">            &quot;&#125;);&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;description&quot;: &quot;Code snippet for &#x27;dispatch&#x27;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>Ctrl+Shift+D </p>
<p>Run Extension</p>
<p>Tip:<br>可能需要更新VSCode版本</p>
<h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><blockquote>
<p>vsce package</p>
</blockquote>
<p>Tip:<br>1 可能需要在package.json中加入发布者名称</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;publisher&quot;: &quot;yinhao&quot;,</span><br></pre></td></tr></table></figure>
<p>2 可能需要修改 README.md</p>
<h3 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h3><p>Ctrl+Shift+p</p>
<p>extension : …</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/10/12/%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84vscode%E6%8F%92%E4%BB%B6/" data-id="cm48jokd3001loni89j4ren12" data-title="实现简单的vscode插件" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Introduction-to-Mobx" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/08/28/Introduction-to-Mobx/" class="article-date">
  <time class="dt-published" datetime="2019-08-27T16:11:00.000Z" itemprop="datePublished">2019-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/08/28/Introduction-to-Mobx/">Introduction to Mobx</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="Mobx是什么"><a href="#Mobx是什么" class="headerlink" title="Mobx是什么"></a>Mobx是什么</h3><p>MobX实现简单、可扩展的状态管理。</p>
<p>使用MobX将应用变成响应式可归纳为三部曲：</p>
<blockquote>
<p>定义状态并使其可观察 (Observable)<br>创建视图以响应状态的变化 (observer)<br>更改状态(action)</p>
</blockquote>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><blockquote>
<p>cnpm install –save mobx mobx-react</p>
</blockquote>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h5 id="Observable"><a href="#Observable" class="headerlink" title="Observable"></a>Observable</h5><blockquote>
<p>Observable 值可以是JS基本数据类型、引用类型、普通对象、类实例、数组和映射。</p>
</blockquote>
<p>返回相应的<code>Observable</code>对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;observable&#125; <span class="keyword">from</span> <span class="string">&#x27;mobx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> map = observable.<span class="title function_">map</span>(&#123; <span class="attr">key</span>: <span class="string">&quot;value&quot;</span>&#125;);</span><br><span class="line">map.<span class="title function_">set</span>(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;new value&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> list = <span class="title function_">observable</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>]);</span><br><span class="line">list[<span class="number">2</span>] = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person = <span class="title function_">observable</span>(&#123;</span><br><span class="line">    <span class="attr">firstName</span>: <span class="string">&quot;Clive Staples&quot;</span>,</span><br><span class="line">    <span class="attr">lastName</span>: <span class="string">&quot;Lewis&quot;</span></span><br><span class="line">&#125;);</span><br><span class="line">person.<span class="property">firstName</span> = <span class="string">&quot;C.S.&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> temperature = observable.<span class="title function_">box</span>(<span class="number">20</span>);</span><br><span class="line">temperature.<span class="title function_">set</span>(<span class="number">25</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;observable&#125; <span class="keyword">from</span> <span class="string">&#x27;mobx&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> appState = <span class="title function_">observable</span>(&#123;</span><br><span class="line">    <span class="attr">timer</span>: <span class="number">0</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="observer"><a href="#observer" class="headerlink" title="observer"></a>observer</h5><p>使用mobx-react observer() 来包裹 React 组件，形成了<code>observer</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; observer &#125; <span class="keyword">from</span> <span class="string">&#x27;mobx-react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="title class_">App</span> = <span class="title function_">observer</span>(<span class="function">(<span class="params">&#123; appState &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Time passed: &#123;appState.timer&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; observer &#125; <span class="keyword">from</span> <span class="string">&#x27;mobx-react&#x27;</span>;</span><br><span class="line"></span><br><span class="line">@observer</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&quot;App&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Time passed: &#123;this.props.appState.timer&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> <span class="attr">appState</span>=<span class="string">&#123;appState&#125;</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h5 id="action"><a href="#action" class="headerlink" title="action"></a>action</h5><figure class="highlight plaintext"><figcaption><span>用来改变 ```observable```的状态。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>import { observable, action } from ‘mobx’;<br>var appState &#x3D; observable({<br>    timer: 0<br>});<br>appState.resetTimer &#x3D; action(function reset() {<br>    appState.timer &#x3D; 0<br>});<br>appState.addTimer &#x3D; action(function add() {<br>    appState.timer++<br>});<br>let App &#x3D; observer(({ appState }) &#x3D;&gt; {<br>    return (<br>        <div className="App"><br>            <button onClick={appState.resetTimer}><br>                Seconds passed: {appState.timer}<br>            </button><br>            <button onClick={appState.addTimer}><br>                +<br>            </button><br>        </div><br>    );<br>});<br>ReactDOM.render(<App appState={appState} />, document.getElementById(‘root’));</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">需要注意的是，observable的状态不仅仅可以通过action改变。</span><br><span class="line"></span><br><span class="line">##### 对比Mobx和Redux</span><br><span class="line"></span><br><span class="line">* 相比```Redux```，```Mobx``` 省略了很多代码量</span><br><span class="line">* ```Redux```的状态管理更严格</span><br><span class="line">* ```Mobx``` 可以设置多个store，```Redux```只能设置一个</span><br><span class="line">* ```Mobx``` 对性能更友好 （```观察者模式``` vs ```Object.assign()```）</span><br><span class="line"></span><br><span class="line">### 概念回顾</span><br><span class="line"></span><br><span class="line">observable 类似于 store</span><br><span class="line"></span><br><span class="line">observer 是装饰后的react组件</span><br><span class="line"></span><br><span class="line">action 用来改变 observable 的状态</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### Class声明 Observerable</span><br></pre></td></tr></table></figure>
<p>class AppState {<br>    @observable timer &#x3D; 2<br>    @action clearTimer() {<br>        this.timer &#x3D; 0<br>    }<br>}</p>
<p>var appState &#x3D; new AppState()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">@observer</span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    this.props.appState.timer++</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;div className=&quot;App&quot;&gt;</span><br><span class="line">          &lt;h1&gt;Time passed: &#123;this.props.appState.timer&#125;&lt;/h1&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ReactDOM.render(&lt;App appState=&#123;appState&#125; /&gt;, document.getElementById(&#x27;root&#x27;));</span><br></pre></td></tr></table></figure>


<h3 id="组件内定义局部observerable"><a href="#组件内定义局部observerable" class="headerlink" title="组件内定义局部observerable"></a>组件内定义局部observerable</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@observer</span><br><span class="line">class TodoList extends React.Component &#123;</span><br><span class="line">  @observable newTodoTitle = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;form onSubmit=&#123;this.handleFormSubmit&#125;&gt;</span><br><span class="line">          New Todo:</span><br><span class="line">          &lt;input</span><br><span class="line">            type=&quot;text&quot;</span><br><span class="line">            value=&#123;this.newTodoTitle&#125;</span><br><span class="line">            onChange=&#123;this.handleInputChange&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">          &lt;button type=&quot;submit&quot;&gt;Add&lt;/button&gt;</span><br><span class="line">        &lt;/form&gt;</span><br><span class="line">        &lt;hr /&gt;</span><br><span class="line">        &lt;ul&gt;</span><br><span class="line">          &#123;this.props.store.todos.map(todo =&gt; (</span><br><span class="line">            &lt;Todo todo=&#123;todo&#125; key=&#123;todo.id&#125; /&gt;</span><br><span class="line">          ))&#125;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line">        Tasks left: &#123;this.props.store.unfinishedTodoCount&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @action</span><br><span class="line">  handleInputChange = e =&gt; &#123;</span><br><span class="line">    this.newTodoTitle = e.target.value;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  @action</span><br><span class="line">  handleFormSubmit = e =&gt; &#123;</span><br><span class="line">    this.props.store.addTodo(this.newTodoTitle);</span><br><span class="line">    this.newTodoTitle = &quot;&quot;;</span><br><span class="line">    e.preventDefault();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class AppState &#123;</span><br><span class="line">    @observable timer = 2</span><br><span class="line">    @computed get timessTwo() &#123;</span><br><span class="line">        return this.timer * 2</span><br><span class="line">    &#125;</span><br><span class="line">    set timessTwo(timessTwo) &#123;</span><br><span class="line">        this.timer = timessTwo / 2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">@observer</span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    this.props.appState.timessTwo++</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;div className=&quot;App&quot;&gt;</span><br><span class="line">          &lt;h1&gt;Time passed: &#123;this.props.appState.timer&#125;&lt;/h1&gt;</span><br><span class="line">          &lt;h2&gt;after times 2 :&#123;this.props.appState.timessTwo&#125;&lt;/h2&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="autorun-reaction"><a href="#autorun-reaction" class="headerlink" title="autorun &amp; reaction"></a>autorun &amp; reaction</h3><p>监听</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">autorun(() =&gt; &#123;</span><br><span class="line">    console.log(appState.timer)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const reaction1 = reaction(</span><br><span class="line">    () =&gt; appState.timer ,</span><br><span class="line">    timer =&gt; console.log(`reaction 1: $&#123;timer&#125;`)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm i mobx-react-devtools</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import DevTools from &quot;mobx-react-devtools&quot;;</span><br><span class="line"></span><br><span class="line">&#123;process.env.NODE_ENV !== &#x27;production&#x27; ? &lt;DevTools /&gt; : null&#125;</span><br></pre></td></tr></table></figure>

<h3 id="严格模式"><a href="#严格模式" class="headerlink" title="严格模式"></a>严格模式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import &#123; configure &#125; from &quot;mobx&quot;;</span><br><span class="line">configure(&#123; enforceActions: true &#125;) // 不允许在action之外进行状态修改</span><br></pre></td></tr></table></figure>

<h3 id="异步"><a href="#异步" class="headerlink" title="异步"></a>异步</h3><p>1 runInAction</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mobx.configure(&#123; enforceActions: true &#125;)</span><br><span class="line"></span><br><span class="line">class Store &#123;</span><br><span class="line">    @observable githubProjects = []</span><br><span class="line">    @observable state = &quot;pending&quot; // &quot;pending&quot; / &quot;done&quot; / &quot;error&quot;</span><br><span class="line"></span><br><span class="line">    @action</span><br><span class="line">    fetchProjects() &#123;</span><br><span class="line">        this.githubProjects = []</span><br><span class="line">        this.state = &quot;pending&quot;</span><br><span class="line">        fetchGithubProjectsSomehow().then(</span><br><span class="line">            projects =&gt; &#123;</span><br><span class="line">                const filteredProjects = somePreprocessing(projects)</span><br><span class="line">                // 将‘“最终的”修改放入一个异步动作中</span><br><span class="line">                runInAction(() =&gt; &#123;</span><br><span class="line">                    this.githubProjects = filteredProjects</span><br><span class="line">                    this.state = &quot;done&quot;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            error =&gt; &#123;</span><br><span class="line">                // 过程的另一个结局:...</span><br><span class="line">                runInAction(() =&gt; &#123;</span><br><span class="line">                    this.state = &quot;error&quot;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2 await&#x2F;async</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">class Store &#123;</span><br><span class="line">    @observable githubProjects = []</span><br><span class="line">    @observable state = &quot;pending&quot; // &quot;pending&quot; / &quot;done&quot; / &quot;error&quot;</span><br><span class="line"></span><br><span class="line">    @action</span><br><span class="line">    async fetchProjects() &#123;</span><br><span class="line">        this.githubProjects = []</span><br><span class="line">        this.state = &quot;pending&quot;</span><br><span class="line">        try &#123;</span><br><span class="line">            const projects = await fetchGithubProjectsSomehow()</span><br><span class="line">            const filteredProjects = somePreprocessing(projects)</span><br><span class="line">            // await 之后，再次修改状态需要动作:</span><br><span class="line">            runInAction(() =&gt; &#123;</span><br><span class="line">                this.state = &quot;done&quot;</span><br><span class="line">                this.githubProjects = filteredProjects</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            runInAction(() =&gt; &#123;</span><br><span class="line">                this.state = &quot;error&quot;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3 flow(generator function)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class Store &#123;</span><br><span class="line">    @observable githubProjects = []</span><br><span class="line">    @observable state = &quot;pending&quot;</span><br><span class="line"></span><br><span class="line">    fetchProjects = flow(function * () &#123; // &lt;- 注意*号，这是生成器函数！</span><br><span class="line">        this.githubProjects = []</span><br><span class="line">        this.state = &quot;pending&quot;</span><br><span class="line">        try &#123;</span><br><span class="line">            const projects = yield fetchGithubProjectsSomehow() // 用 yield 代替 await</span><br><span class="line">            const filteredProjects = somePreprocessing(projects)</span><br><span class="line">            // 异步代码块会被自动包装成动作并修改状态</span><br><span class="line">            this.state = &quot;done&quot;</span><br><span class="line">            this.githubProjects = filteredProjects</span><br><span class="line">        &#125; catch (error) &#123;</span><br><span class="line">            this.state = &quot;error&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="tip"><a href="#tip" class="headerlink" title="tip"></a>tip</h3><h5 id="使用大量的小组件"><a href="#使用大量的小组件" class="headerlink" title="使用大量的小组件"></a>使用大量的小组件</h5><p>@observer 组件会追踪它们使用的所有值，并且当它们中的任何一个改变时重新渲染。 所以你的组件越小，它们需要重新渲染产生的变化则越小;这意味着用户界面的更多部分具备彼此独立渲染的可能性。</p>
<h3 id="脚手架"><a href="#脚手架" class="headerlink" title="脚手架"></a>脚手架</h3><p><a target="_blank" rel="noopener" href="https://github.com/mobxjs/mobx-react-boilerplate"> https://github.com/mobxjs/mobx-react-boilerplate</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/08/28/Introduction-to-Mobx/" data-id="cm48jokcy000goni8fnl536z4" data-title="Introduction to Mobx" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-React-PureComponent-React-memo" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/08/15/React-PureComponent-React-memo/" class="article-date">
  <time class="dt-published" datetime="2019-08-15T07:24:00.000Z" itemprop="datePublished">2019-08-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/08/15/React-PureComponent-React-memo/">React.PureComponent &amp; React.memo()</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>问题： react中如何尽量减少不必要的渲染</p>
</blockquote>
<h3 id="shouldComponentUpdate"><a href="#shouldComponentUpdate" class="headerlink" title="shouldComponentUpdate()"></a>shouldComponentUpdate()</h3><p>它是react的一个生命周期</p>
<p><img src="https://upload-images.jianshu.io/upload_images/9594241-39958e7a1941ea99.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图片来自：https://segmentfault.com/a/1190000016494335"></p>
<p>组件state或props被更新时可以通过这个生命周期判断是否继续渲染。</p>
<p>它接受两个参数<code>nextProps</code>、<code>nextState</code>，返回一个布尔值。</p>
<p>若不在代码中声明该生命周期，react默认的处理是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">shouldComponentUpdate</span>(<span class="params">nextProps, nextState</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写代码的时候可以通过该生命周期来优化渲染</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shouldComponentUpdate(nextProps, nextState) &#123;</span><br><span class="line">    if (this.props.name === nextProps.name) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="React-PureComponent"><a href="#React-PureComponent" class="headerlink" title="React.PureComponent"></a>React.PureComponent</h3><p>大部分情况下，你可以使用 <code>React.PureComponent</code> 来代替手写 <code>shouldComponentUpdate</code>。</p>
<p>以下两者效果相同：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import React from &#x27;react&#x27;;</span><br><span class="line"></span><br><span class="line">class Child extends React.Component &#123;</span><br><span class="line">    shouldComponentUpdate(nextProps, nextState) &#123;</span><br><span class="line">        if (this.props.name === nextProps.name) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    render() &#123;</span><br><span class="line">        console.log(&#x27;render&#x27;)</span><br><span class="line">        return (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                child,&#123;this.props.name&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default Child;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import React from &#x27;react&#x27;;</span><br><span class="line"></span><br><span class="line">class Child extends React.PureComponent &#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        console.log(&#x27;render&#x27;)</span><br><span class="line">        return (</span><br><span class="line">            &lt;div&gt;</span><br><span class="line">                child,&#123;this.props.name&#125;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default Child;</span><br></pre></td></tr></table></figure>
<p><code>React.PureComponent</code>只进行浅比较（shallowEqual）：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react/blob/a9b035b0c2b8235405835beca0c4db2cc37f18d0/packages/shared/shallowEqual.js" title="packages/shared/shallowEqual.js">react shallowEqual 源码</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">const hasOwn = Object.prototype.hasOwnProperty</span><br><span class="line"></span><br><span class="line">function is(x, y) &#123;</span><br><span class="line">  if (x === y) &#123;</span><br><span class="line">    return x !== 0 || y !== 0 || 1 / x === 1 / y</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return x !== x &amp;&amp; y !== y</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default function shallowEqual(objA, objB) &#123;</span><br><span class="line">  if (is(objA, objB)) return true</span><br><span class="line"></span><br><span class="line">  if (typeof objA !== &#x27;object&#x27; || objA === null ||</span><br><span class="line">      typeof objB !== &#x27;object&#x27; || objB === null) &#123;</span><br><span class="line">    return false</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const keysA = Object.keys(objA)</span><br><span class="line">  const keysB = Object.keys(objB)</span><br><span class="line"></span><br><span class="line">  if (keysA.length !== keysB.length) return false</span><br><span class="line"></span><br><span class="line">  for (let i = 0; i &lt; keysA.length; i++) &#123;</span><br><span class="line">    if (!hasOwn.call(objB, keysA[i]) ||</span><br><span class="line">        !is(objA[keysA[i]], objB[keysA[i]])) &#123;</span><br><span class="line">      return false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="React-memo"><a href="#React-memo" class="headerlink" title="React.memo()"></a>React.memo()</h3><p>它是React 16.8 的新特性之一</p>
<p><code>React.memo</code> 为高阶组件。它与 <code>React.PureComponent</code> 非常相似，但它适用于函数组件，但不适用于 class 组件。</p>
<p>使用方法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="comment">/* 使用 props 渲染 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">areEqual</span>(<span class="params">prevProps, nextProps</span>) &#123;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  如果把 nextProps 传入 render 方法的返回结果与</span></span><br><span class="line"><span class="comment">  将 prevProps 传入 render 方法的返回结果一致则返回 true，</span></span><br><span class="line"><span class="comment">  否则返回 false</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="title class_">MyComponent</span>, areEqual);</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://www.imweb.io/topic/598973c2c72aa8db35d2e291">https://www.imweb.io/topic/598973c2c72aa8db35d2e291</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/08/15/React-PureComponent-React-memo/" data-id="cm48jokcz000moni88wfadyhi" data-title="React.PureComponent &amp; React.memo()" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-redux-saga" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/08/08/redux-saga/" class="article-date">
  <time class="dt-published" datetime="2019-08-07T16:19:00.000Z" itemprop="datePublished">2019-08-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/08/08/redux-saga/">redux-saga</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>redux-saga 是一个用于管理应用程序 Side Effect（副作用，例如异步获取数据，访问浏览器缓存等）的 library，它的目标是让副作用管理更容易，执行更高效，测试更简单，在处理故障时更容易。</p>
<h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>利用同步方式处理异步逻辑<br>api丰富，灵活操纵异步行为</p>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><blockquote>
<p>cnpm install redux-saga</p>
</blockquote>
<p>store</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;createStore,applyMiddleware&#125;  <span class="keyword">from</span> <span class="string">&quot;redux&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">&quot;./reducer&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> createSagaMiddleware <span class="keyword">from</span> <span class="string">&quot;redux-saga&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;rootSaga&#125; <span class="keyword">from</span> <span class="string">&quot;../saga&quot;</span></span><br><span class="line"><span class="comment">//执行它可以得到中间件函数</span></span><br><span class="line"><span class="keyword">let</span> sagaMiddleware = <span class="title function_">createSagaMiddleware</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> store = <span class="title function_">createStore</span>(reducer,<span class="title function_">applyMiddleware</span>(sagaMiddleware));</span><br><span class="line"><span class="comment">//开始执行rootSaga</span></span><br><span class="line"> sagaMiddleware.<span class="title function_">run</span>(rootSaga);</span><br><span class="line"> <span class="keyword">export</span> <span class="keyword">default</span> store;</span><br></pre></td></tr></table></figure>
<p>saga</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import &#123;takeEvery,put,all,call&#125; from &quot;redux-saga/effects&quot;;</span><br><span class="line">const delay = ms=&gt;new Promise((resolve,reject)=&gt;&#123;</span><br><span class="line">   setTimeout(()=&gt;&#123;</span><br><span class="line">       resolve()</span><br><span class="line">   &#125;,ms)</span><br><span class="line">&#125;);</span><br><span class="line">function* add(dispatch,action) &#123;</span><br><span class="line">    yield call(delay,1000);</span><br><span class="line">    yield put(&#123;type:&#x27;ADD&#x27;&#125;);</span><br><span class="line">&#125;</span><br><span class="line">function* watchAdd() &#123;</span><br><span class="line">    //监听派发给仓库的动作，如果动作类型匹配的话，会执行对应的监听生成器</span><br><span class="line">    yield takeEvery(&#x27;ADD_ASYNC&#x27;,add)</span><br><span class="line">&#125;</span><br><span class="line">export function* rootSaga() &#123;</span><br><span class="line">    yield watchAdd()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="api"><a href="#api" class="headerlink" title="api"></a>api</h3><p><code>put</code> 相当于 <code>dispatch</code><br><code>call</code> 相当于 js 里的 <code>call</code><br><code>take</code> 阻塞当前 saga，直到接收到指定的 action，代码才会继续往下执行<br><code>fork</code> 类似于 <code>call</code> effect，区别在于它不会阻塞当前 saga，如同后台运行一般，它的返回值是一个 task 对象<br><code>cancel</code> 针对 <code>fork</code> 方法返回的 task ，可以进行取消关闭</p>
<h3 id="辅助函数"><a href="#辅助函数" class="headerlink" title="辅助函数"></a>辅助函数</h3><p><code>takeEvery</code>  在发起（dispatch）到 Store 并且匹配 pattern 的每一个 action 上派生一个 saga。<br><code>takeLatest</code> 在发起到 Store 并且匹配 pattern 的每一个 action 上派生一个 saga。并自动取消之前所有已经启动但仍在执行中的 saga 任务。<br><code>takeLeading</code> 在发起到 Store 并且匹配 pattern 的每一个 action 上派生一个 saga。 它将在派生一次任务之后阻塞，直到派生的 saga 完成，然后又再次开始监听指定的 pattern。</p>
<h3 id="有趣的用法"><a href="#有趣的用法" class="headerlink" title="有趣的用法"></a>有趣的用法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function* controlSaga (action) &#123;</span><br><span class="line">    const task = yield fork(getDataSaga, action); // 运行getDataSaga这个任务</span><br><span class="line">    yield race([ // 利用rece谁先来用谁的原则，完美解决 超时自动取消与手动取消的 的问题</span><br><span class="line">        take(&#x27;CANCEL_REQUEST&#x27;), // 到这步时就阻塞住了，直到发出type为&#x27;CANCEL_REQUEST&#x27;的action，才会继续往下</span><br><span class="line">        call(delay, 1000) // 控制时间</span><br><span class="line">    ]);</span><br><span class="line">    yield cancel(task); // 取消任务，取消后，cancelled() 会返回true，否则返回false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考 ：</p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5ad83a70f265da503825b2b4">https://juejin.im/post/5ad83a70f265da503825b2b4</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/35437092?group_id=966592505576407040">https://zhuanlan.zhihu.com/p/35437092?group_id&#x3D;966592505576407040</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/08/08/redux-saga/" data-id="cm48jokd10016oni8e7qse487" data-title="redux-saga" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-redux-thunk" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/30/redux-thunk/" class="article-date">
  <time class="dt-published" datetime="2019-07-30T03:50:58.000Z" itemprop="datePublished">2019-07-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/30/redux-thunk/">redux-thunk</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="Redux数据流"><a href="#Redux数据流" class="headerlink" title="Redux数据流"></a>Redux数据流</h3><p>view -&gt; dispatch-&gt; action -&gt; reducer -&gt; state</p>
<h3 id="中间件-MiddleWare"><a href="#中间件-MiddleWare" class="headerlink" title="中间件(MiddleWare)"></a>中间件(MiddleWare)</h3><blockquote>
<p>它提供的是位于 action 被发起之后，到达 reducer 之前的扩展点。 你可以利用 Redux middleware 来进行日志记录、创建崩溃报告、调用异步接口或者路由等等。</p>
</blockquote>
<p>view -&gt; ||<code>被扩展的部分</code> dispatch-&gt; action -&gt; <code>被扩展的部分</code>||reducer -&gt; state</p>
<p>一个简单的中间件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">logger</span> = store =&gt; <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;dispatch&#x27;</span>,action)</span><br><span class="line">    <span class="title function_">next</span>(action)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;finish&#x27;</span> , action)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中间件的使用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">createStore</span>(store,<span class="literal">null</span>, <span class="title function_">applyMiddleware</span>(logger))</span><br></pre></td></tr></table></figure>
<p>返回一个增强后的createStore</p>
<p>createStore源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果 preloadedState类型是function，enhancer类型是undefined，那认为用</span></span><br><span class="line">  <span class="comment">// 户没有传入preloadedState，就将preloadedState的值传给  </span></span><br><span class="line">  <span class="comment">// enhancer，preloadedState值设置为undefined</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    enhancer = preloadedState</span><br><span class="line">    preloadedState = <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// enhancer类型必须是一个function</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Expected the enhancer to be a function.&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回使用enhancer增强后的store</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">enhancer</span>(createStore)(reducer, preloadedState)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//......</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>applyMiddleware源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">applyMiddleware</span>(<span class="params">...middlewares</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">createStore</span>) =&gt;</span> <span class="function">(<span class="params">reducer, preloadedState, enhancer</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> store = <span class="title function_">createStore</span>(reducer, preloadedState, enhancer)</span><br><span class="line">    <span class="keyword">let</span> dispatch = store.<span class="property">dispatch</span></span><br><span class="line">    <span class="keyword">let</span> chain = []  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      <span class="attr">getState</span>: store.<span class="property">getState</span>,</span><br><span class="line">      <span class="attr">dispatch</span>: <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="title function_">dispatch</span>(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    chain = middlewares.<span class="title function_">map</span>(<span class="function"><span class="params">middleware</span> =&gt;</span> <span class="title function_">middleware</span>(middlewareAPI))</span><br><span class="line">    dispatch = <span class="title function_">compose</span>(...chain)(store.<span class="property">dispatch</span>) <span class="comment">// 对dispatch方法封装</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="redux-thunk"><a href="#redux-thunk" class="headerlink" title="redux-thunk"></a>redux-thunk</h3><blockquote>
<p>Redux Thunk middleware allows you to write action creators that return a function instead of an action. The thunk can be used to delay the dispatch of an action, or to dispatch only if a certain condition is met. The inner function receives the store methods dispatch and getState as parameters.</p>
</blockquote>
<p>使用</p>
<blockquote>
<p>cnpm install redux-thunk</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">&#x27;redux-thunk&#x27;</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="title function_">createStore</span>(store,<span class="literal">null</span> <span class="title function_">applyMiddleware</span>(thunk))</span><br></pre></td></tr></table></figure>

<p>示例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">INCREMENT_COUNTER</span> = <span class="string">&#x27;INCREMENT_COUNTER&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="variable constant_">INCREMENT_COUNTER</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">incrementAsync</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// Yay! Can invoke sync or async actions with `dispatch`</span></span><br><span class="line">      <span class="title function_">dispatch</span>(<span class="title function_">increment</span>());</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>源码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createThunkMiddleware</span>(<span class="params">extraArgument</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">&#123; dispatch, getState &#125;</span>) =&gt;</span> <span class="function"><span class="params">next</span> =&gt;</span> <span class="function"><span class="params">action</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">action</span>(dispatch, getState, extraArgument);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">next</span>(action);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunk = <span class="title function_">createThunkMiddleware</span>();</span><br><span class="line">thunk.<span class="property">withExtraArgument</span> = createThunkMiddleware;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> thunk;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/30/redux-thunk/" data-id="cm48jokd10017oni877vyaevf" data-title="redux-thunk" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-React-High-Order-Component" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/25/React-High-Order-Component/" class="article-date">
  <time class="dt-published" datetime="2019-07-25T14:45:00.000Z" itemprop="datePublished">2019-07-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/25/React-High-Order-Component/">React High Order Component</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="高阶函数：接受一个或多个函数并返回一个函数"><a href="#高阶函数：接受一个或多个函数并返回一个函数" class="headerlink" title="高阶函数：接受一个或多个函数并返回一个函数"></a>高阶函数：接受一个或多个函数并返回一个函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var add = function (x) &#123;</span><br><span class="line">      return function (y) &#123;</span><br><span class="line">          return x + y;</span><br><span class="line">      &#125;</span><br><span class="line"> &#125;</span><br><span class="line">add(1)(2); // 3</span><br></pre></td></tr></table></figure>
<p>JS中，array的map、filter、reduce等方法就是高阶函数的例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var numbers = [1, 2, 3, 4];</span><br><span class="line">function double(num) &#123;</span><br><span class="line">    return num * 2;</span><br><span class="line">&#125;</span><br><span class="line">var doubledNumbers = numbers.map(double); //[2,4,6,8]</span><br></pre></td></tr></table></figure>

<h4 id="高阶函数的应用—柯里化"><a href="#高阶函数的应用—柯里化" class="headerlink" title="高阶函数的应用—柯里化"></a>高阶函数的应用—柯里化</h4><p>一道经典面试题</p>
<blockquote>
<p>写一个add方法实现以下效果</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(1) //1</span><br><span class="line">add(1)(2) //3</span><br><span class="line">add(1)(2)(3) //6</span><br><span class="line">add(1)(2)(3)(4) //10</span><br></pre></td></tr></table></figure>

<blockquote>
<p>答案之一:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function add(a) &#123;</span><br><span class="line">    function sum(b) &#123; // 使用闭包</span><br><span class="line">    	a = a + b; // 累加</span><br><span class="line">    	return sum;</span><br><span class="line">    &#125;</span><br><span class="line">    sum.toString = function() &#123; // 重写toString()方法</span><br><span class="line">        return a;</span><br><span class="line">    &#125;</span><br><span class="line">    return sum; // 返回一个函数</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里的add就是高阶函数</p>
<h3 id="高阶组件：接受一个组件并返回一个组件"><a href="#高阶组件：接受一个组件并返回一个组件" class="headerlink" title="高阶组件：接受一个组件并返回一个组件"></a>高阶组件：接受一个组件并返回一个组件</h3><p>实现方式 1 属性代理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const Container = (WrappedComponent) =&gt;</span><br><span class="line">	class extends React.Component &#123;</span><br><span class="line">		render() &#123;</span><br><span class="line">			let newProps = &#123; status: &#x27;ok&#x27; &#125;</span><br><span class="line">			return &lt;WrappedComponent &#123;...this.props&#125; &#123;...newProps&#125; /&gt;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>实现方式 2 反向继承</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const Container = (WrappedComponent) =&gt;</span><br><span class="line">	class extends WrappedComponent &#123;</span><br><span class="line">		render() &#123;</span><br><span class="line">			return super.render()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Tips: super语法：</p>
</blockquote>
<p>1  super([arguments]); &#x2F;&#x2F; 访问父对象上的构造函数</p>
<p>2  super.functionOnParent([arguments]); &#x2F;&#x2F; 访问对象上的方法</p>
<p>高阶组件使用方式 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class App extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        ...</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default Container(App);</span><br></pre></td></tr></table></figure>
<p>or Decorator方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Container</span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        ...</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Tips: ES6装饰器的说明：</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@decorator</span><br><span class="line">class A &#123;&#125;</span><br><span class="line"></span><br><span class="line">// 等同于</span><br><span class="line"></span><br><span class="line">class A &#123;&#125;</span><br><span class="line">A = decorator(A) || A;</span><br></pre></td></tr></table></figure>

<p>高阶组件的应用：</p>
<ul>
<li>控制props</li>
<li>渲染劫持</li>
<li>控制state</li>
<li>为组件增加统一的样式或布局</li>
<li>。。。</li>
</ul>
<h3 id="高阶组件应用之react-redux里的connect"><a href="#高阶组件应用之react-redux里的connect" class="headerlink" title="高阶组件应用之react-redux里的connect"></a>高阶组件应用之react-redux里的connect</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; Component &#125; from &#x27;react&#x27;</span><br><span class="line">import PropTypes from &#x27;prop-types&#x27;</span><br><span class="line"></span><br><span class="line">const connect = (mapStateToProps)=&gt;(WrappedComponent) =&gt; &#123;</span><br><span class="line">  class Connect extends Component &#123;</span><br><span class="line">    static contextTypes = &#123;</span><br><span class="line">      store: PropTypes.object</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    constructor () &#123;</span><br><span class="line">      super()</span><br><span class="line">      this.state = &#123; allProps: &#123;&#125; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    componentWillMount () &#123;</span><br><span class="line">      const &#123; store &#125; = this.context</span><br><span class="line">      this._updateProps()</span><br><span class="line">      store.subscribe(() =&gt; this._updateProps())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _updateProps () &#123;</span><br><span class="line">      const &#123; store &#125; = this.context</span><br><span class="line">      let stateProps = mapStateToProps(store.getState())</span><br><span class="line">      stateProps.dispatch=store.dispatch</span><br><span class="line">      this.setState(&#123;</span><br><span class="line">        allProps: &#123; // 整合普通的 props 和从 state 生成的 props</span><br><span class="line">          ...stateProps,</span><br><span class="line">          ...this.props</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    render () &#123;</span><br><span class="line">      return &lt;WrappedComponent &#123;...this.state.allProps&#125;/&gt;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return Connect</span><br><span class="line">&#125;</span><br><span class="line">export default connect</span><br></pre></td></tr></table></figure>


<p>使用connect</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import React, &#123; PureComponent &#125; from &#x27;react&#x27;;</span><br><span class="line">import &#123; connect &#125; from &#x27;dva&#x27;;</span><br><span class="line">import LoginForm from &#x27;./LoginForm&#x27;;</span><br><span class="line"></span><br><span class="line">@connect((&#123; login, loading &#125;) =&gt; (&#123;</span><br><span class="line">    login,</span><br><span class="line">    loading,</span><br><span class="line">&#125;))</span><br><span class="line">export default class Login extends PureComponent &#123;</span><br><span class="line">    render() &#123;</span><br><span class="line">        const &#123; dispatch, loading &#125; = this.props;</span><br><span class="line">        return (</span><br><span class="line">            &lt;LoginForm</span><br><span class="line">                isLoading=&#123;loading.effects[&#x27;login/login&#x27;]&#125;</span><br><span class="line">                onOk=&#123;(data) =&gt; &#123;</span><br><span class="line">                    dispatch(&#123;</span><br><span class="line">                        type: &#x27;login/login&#x27;,</span><br><span class="line">                        payload: &#123;</span><br><span class="line">                            ...data,</span><br><span class="line">                        &#125;,</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;&#125;</span><br><span class="line">            /&gt;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>注意：<br>1、不要在render中构建高阶组件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">  // 每次调用 render 函数都会创建一个新的 EnhancedComponent</span><br><span class="line">  // EnhancedComponent1 !== EnhancedComponent2</span><br><span class="line">  const EnhancedComponent = enhance(MyComponent);</span><br><span class="line">  // 这将导致子树每次渲染都会进行卸载，和重新挂载的操作！</span><br><span class="line">  return &lt;EnhancedComponent /&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、注意添加原组件的静态方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function enhance(WrappedComponent) &#123;</span><br><span class="line">  class Enhance extends React.Component &#123;/*...*/&#125;</span><br><span class="line">  // 必须准确知道应该拷贝哪些方法 :(</span><br><span class="line">  Enhance.staticMethod = WrappedComponent.staticMethod;</span><br><span class="line">  return Enhance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、ref和key不会被传递</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/25/React-High-Order-Component/" data-id="cm48jokcz000koni8bia5bcgc" data-title="React High Order Component" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-踩坑-create-react-app-支持decorators的方法" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/07/23/%E8%B8%A9%E5%9D%91-create-react-app-%E6%94%AF%E6%8C%81decorators%E7%9A%84%E6%96%B9%E6%B3%95/" class="article-date">
  <time class="dt-published" datetime="2019-07-23T14:14:38.000Z" itemprop="datePublished">2019-07-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/07/23/%E8%B8%A9%E5%9D%91-create-react-app-%E6%94%AF%E6%8C%81decorators%E7%9A%84%E6%96%B9%E6%B3%95/">踩坑-create-react-app 支持decorators的方法</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cnpm i @babel/core --save</span><br><span class="line">cnpm i @babel/plugin-proposal-class-properties --save</span><br><span class="line">cnpm i @babel/plugin-proposal-decorators --save</span><br><span class="line">cnpm i @babel/preset-env --save</span><br></pre></td></tr></table></figure>

<p>创建 .babelrc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;presets&quot;: [</span><br><span class="line">        &quot;@babel/preset-env&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;plugins&quot;: [</span><br><span class="line">        [</span><br><span class="line">            &quot;@babel/plugin-proposal-decorators&quot;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;legacy&quot;: true</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        [</span><br><span class="line">            &quot;@babel/plugin-proposal-class-properties&quot;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;loose&quot;: true</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建config-override.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&#x27;path&#x27;)</span><br><span class="line">const BundleAnalyzerPlugin = require(&#x27;webpack-bundle-analyzer&#x27;).BundleAnalyzerPlugin</span><br><span class="line">const &#123; override, addDecoratorsLegacy &#125; = require(&#x27;customize-cra&#x27;)</span><br><span class="line"></span><br><span class="line">function resolve(dir) &#123;</span><br><span class="line">    return path.join(__dirname, dir)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const customize = () =&gt; (config, env) =&gt; &#123;</span><br><span class="line">    config.resolve.alias[&#x27;@&#x27;] = resolve(&#x27;src&#x27;)</span><br><span class="line">    if (env === &#x27;production&#x27;) &#123;</span><br><span class="line">        config.externals = &#123;</span><br><span class="line">            &#x27;react&#x27;: &#x27;React&#x27;,</span><br><span class="line">            &#x27;react-dom&#x27;: &#x27;ReactDOM&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">        // config.plugins.push(new BundleAnalyzerPlugin())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return config</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">module.exports = override(addDecoratorsLegacy(), customize())</span><br></pre></td></tr></table></figure>
<p>安装依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cnpm i customize-cra --save-dev</span><br><span class="line">cnpm i react-app-rewired --save-dev</span><br><span class="line">cnpm i webpack-bundle-analyzer --save-dev</span><br></pre></td></tr></table></figure>


<p>修改package.json</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;start&quot;: &quot;react-app-rewired start&quot;,</span><br><span class="line">    &quot;build&quot;: &quot;react-app-rewired build&quot;,</span><br><span class="line">    &quot;test&quot;: &quot;react-app-rewired test&quot;,</span><br><span class="line">    &quot;eject&quot;: &quot;react-app-rewired eject&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/23/%E8%B8%A9%E5%9D%91-create-react-app-%E6%94%AF%E6%8C%81decorators%E7%9A%84%E6%96%B9%E6%B3%95/" data-id="cm48jokd4001uoni8gqfz8at4" data-title="踩坑-create-react-app 支持decorators的方法" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FrontEnd/" rel="tag">FrontEnd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CSS/" style="font-size: 10px;">CSS</a> <a href="/tags/FrontEnd/" style="font-size: 10px;">FrontEnd</a> <a href="/tags/React/" style="font-size: 10px;">React</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/11/">November 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/12/">December 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">April 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/11/28/Dependecy-Injection/">Dependecy Injection</a>
          </li>
        
          <li>
            <a href="/2024/06/28/Date-Time-Format/">Date Time Format</a>
          </li>
        
          <li>
            <a href="/2024/04/16/Jest/">Jest</a>
          </li>
        
          <li>
            <a href="/2023/12/28/%E3%80%8AGoogle-%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B%E3%80%8B-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B01/">《Google 软件工程》 读书笔记1</a>
          </li>
        
          <li>
            <a href="/2023/01/13/VS-Code-C-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE-MacOS/">VS Code C++ 环境配置 (MacOS)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 Billy Yin<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>